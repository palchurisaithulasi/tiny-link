const express = require("express");
const router = express.Router();

const { createShortLink, links } = require("../db/index");

// CREATE SHORT LINK
router.post("/", (req, res) => {
  const { url } = req.body;

  if (!url) {
    return res.status(400).json({ error: "URL is required" });
  }

  // Create short code + store it
  const code = createShortLink(url);

  res.json({
    success: true,
    code: code,
    shortUrl: `http://localhost:3000/${code}`,
  });
});

// DEBUG: SHOW ALL STORED LINKS
router.get("/debug/all", (req, res) => {
  res.json({ links });
});

// DELETE SHORT LINK
router.delete("/:code", (req, res) => {
  const code = req.params.code;

  if (!links[code]) {
    return res.status(404).json({ error: "Code not found" });
  }

  delete links[code];
  res.json({ success: true, message: "Short link deleted" });
});

// GET STATS FOR A SINGLE SHORT CODE
router.get("/:code", (req, res) => {
  const code = req.params.code;

  if (!links[code]) {
    return res.status(404).json({ error: "Code not found" });
  }

  res.json({
    success: true,
    code: code,
    url: links[code],
  });
});

module.exports = router;