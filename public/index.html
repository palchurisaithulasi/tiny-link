<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TinyLink Dashboard</title>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; padding: 20px; max-width: 900px; margin: auto; }
    input[type="text"] { padding: 8px; font-size: 14px; }
    button { padding: 8px 12px; font-size: 14px; margin-left: 6px; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; vertical-align: middle; }
    th { background: #f7f7f7; }
    .result { margin-top: 12px; color: #0b6; }
    .error { margin-top: 12px; color: #c00; }
    .small { font-size: 12px; color:#666; }
    .actions button { margin-right: 6px; }
    a.code-link { font-weight: bold; text-decoration: none; color: #0366d6; }
  </style>
</head>
<body>
  <h1>TinyLink Dashboard</h1>

  <section>
    <h2>Create Short URL</h2>
    <input id="longUrl" type="text" placeholder="Enter long URL (e.g. https://google.com)" style="width:70%;" />
    <button id="shortenBtn">Shorten</button>
    <div id="result" class="result" role="status" aria-live="polite"></div>
    <div id="error" class="error" role="alert" aria-live="polite"></div>
  </section>

  <section>
    <h2 style="margin-top:24px">All Links</h2>
    <button id="refreshBtn">Refresh List</button>
    <div class="small" style="margin-top:8px">Click code to open, click Delete to remove.</div>

    <table aria-describedby="links-table" style="margin-top:8px;">
      <thead>
        <tr>
          <th style="width:18%">Code</th>
          <th style="width:60%">URL</th>
          <th style="width:22%">Action</th>
        </tr>
      </thead>
      <tbody id="linksTable"></tbody>
    </table>
  </section>

  <script>
    // helper - escape HTML for safety when injecting strings
    function escapeHtml(str) {
      if (typeof str !== 'string') return str;
      return str.replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    // Create a short link (POST /api/links)
    async function createLink() {
      const urlInput = document.getElementById("longUrl");
      const resultEl = document.getElementById("result");
      const errorEl = document.getElementById("error");
      resultEl.textContent = "";
      errorEl.textContent = "";

      const url = urlInput.value && urlInput.value.trim();
      if (!url) {
        errorEl.textContent = "Please enter a URL.";
        return;
      }

      try {
        const res = await fetch("/api/links", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ url })
        });

        const data = await res.json();

        if (!res.ok || !data.success) {
          errorEl.textContent = data.error || "Failed to create link";
          return;
        }

        // show short URL (absolute)
        resultEl.innerHTML = 'Short URL: <a href="' + escapeHtml(data.shortUrl) + '" target="_blank">' + escapeHtml(data.shortUrl) + '</a>';
        urlInput.value = "";
        loadLinks();
      } catch (err) {
        console.error(err);
        errorEl.textContent = "Network error. Try again.";
      }
    }

    // Load all links (debug route). Accepts both shapes:
    // - data.links[code] = "https://google.com"
    // - data.links[code] = { url: "...", clicks: N, lastClicked: ... }
    async function loadLinks() {
      const table = document.getElementById("linksTable");
      table.innerHTML = "<tr><td colspan='3'>Loading...</td></tr>";

      try {
        const res = await fetch("/api/links/debug/all");
        if (!res.ok) {
          table.innerHTML = "<tr><td colspan='3'>Failed to load links</td></tr>";
          return;
        }
        const data = await res.json();
        const links = (data && data.links) || {};

        // build rows
        let rows = "";
        const codes = Object.keys(links);
        if (codes.length === 0) {
          table.innerHTML = "<tr><td colspan='3'>No links yet</td></tr>";
          return;
        }

        for (const code of codes) {
          const item = links[code];

          // support both shapes
          const url = (typeof item === "string") ? item : (item && item.url) ? item.url : "";
          const displayUrl = escapeHtml(url);
          const codeEsc = escapeHtml(code);

          // actions:
          // - open: /code/:code (stats page) and /:code (redirect)
          // - delete: DELETE /api/links/delete/:code
          rows += `<tr>
            <td style="min-width:90px;">
              <a class="code-link" href="/${codeEsc}" target="_blank" title="Open redirect">${codeEsc}</a>
              <div class="small"><a href="/code/${codeEsc}">stats</a></div>
            </td>
            <td>${displayUrl}</td>
            <td class="actions">
              <button onclick="deleteLink('${codeEsc}')">Delete</button>
            </td>
          </tr>`;
        }

        table.innerHTML = rows;
      } catch (err) {
        console.error(err);
        table.innerHTML = "<tr><td colspan='3'>Network or parsing error</td></tr>";
      }
    }

    // Delete using current backend path (DELETE /api/links/delete/:code)
    async function deleteLink(code) {
      if (!confirm("Delete short link " + code + " ?")) return;

      try {
        const res = await fetch("/api/links/delete/" + encodeURIComponent(code), {
          method: "DELETE"
        });
        if (!res.ok) {
          alert("Delete failed");
        }
      } catch (err) {
        console.error(err);
        alert("Network error");
      }
      loadLinks();
    }

    // wire buttons
    document.getElementById("shortenBtn").addEventListener("click", createLink);
    document.getElementById("refreshBtn").addEventListener("click", loadLinks);

    // initial load
    loadLinks();
  </script>
</body>
</html>