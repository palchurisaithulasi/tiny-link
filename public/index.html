<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TinyLink Dashboard</title>

  <style>
    body {
      font-family: Arial, Helvetica, sans-serif;
      padding: 20px;
      max-width: 900px;
      margin: auto;
    }
    input[type="text"] {
      padding: 8px;
      font-size: 14px;
      width: 350px;
    }
    button {
      padding: 8px 12px;
      font-size: 14px;
      margin-left: 6px;
      cursor: pointer;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
      vertical-align: middle;
    }
    th {
      background: #f7f7f7;
    }
    .result { margin-top: 12px; color: #0b6; }
    .error { margin-top: 12px; color: #c00; }
    .small { font-size: 12px; color:#666; }
  </style>
</head>

<body>

<h1>TinyLink Dashboard</h1>

<h3>Create New Short URL</h3>

<input type="text" id="url" placeholder="Enter long URL" />
<input type="text" id="customCode" placeholder="Custom code (optional)" />
<button onclick="createLink()">Create</button>

<div id="result" class="result"></div>
<div id="error" class="error"></div>

<h3>All Short Links</h3>

<p id="loading">Loading...</p>
<p id="empty" style="display:none;">No links yet.</p>

<table>
  <thead>
    <tr>
      <th>Code</th>
      <th>URL</th>
      <th>Clicks</th>
      <th>Last Clicked</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody id="links-table-body"></tbody>
</table>

<script>
async function loadLinks() {
  const tableBody = document.querySelector("#links-table-body");
  const loading = document.querySelector("#loading");
  const empty = document.querySelector("#empty");

  loading.style.display = "block";
  empty.style.display = "none";
  tableBody.innerHTML = "";

  try {
    const res = await fetch("/api/links");
    const data = await res.json();

    loading.style.display = "none";

    if (!data.success || data.links.length === 0) {
      empty.style.display = "block";
      return;
    }

    data.links.forEach(link => {
      const row = document.createElement("tr");

      row.innerHTML = `
        <td>${link.code}</td>
        <td><a href="${link.url}" target="_blank">${link.url}</a></td>
        <td>${link.clicks}</td>
        <td>${link.lastClicked || "Never"}</td>
        <td>
          <a href="/code/${link.code}" target="_blank">Stats</a> |
          <a href="/${link.code}" target="_blank">Open</a>
        </td>
      `;

      tableBody.appendChild(row);
    });
  } catch (err) {
    loading.innerHTML = "Failed to load links.";
  }
}

async function createLink() {
  const url = document.getElementById("url").value.trim();
  const customCode = document.getElementById("customCode").value.trim();
  const result = document.getElementById("result");
  const error = document.getElementById("error");

  result.textContent = "";
  error.textContent = "";

  if (!url) {
    error.textContent = "Please enter a URL.";
    return;
  }

  const body = customCode ? { url, code: customCode } : { url };

  try {
    const res = await fetch("/api/links", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });

    const data = await res.json();

    if (!data.success) {
      error.textContent = data.error || "Failed to create short URL.";
      return;
    }

    result.innerHTML = `Short URL: <a href="${data.shortUrl}" target="_blank">${data.shortUrl}</a>`;

    document.getElementById("url").value = "";
    document.getElementById("customCode").value = "";

    loadLinks();
  } catch (err) {
    error.textContent = "Something went wrong.";
  }
}

window.onload = loadLinks;
</script>

</body>
</html>